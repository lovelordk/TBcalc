import streamlit as st

# ==========================================
# 补充数据：依据文档第八章与第一章
# ==========================================

# 1. 六亲生肖秘表 (完整录入) 
# 格式：生肖: [条文数序列表]
ZODIAC_CODES = {
    '鼠': [1003, 1104, 1205, 1306, 1407, 1508, 1609, 1710],
    '牛': [1005, 1106, 1207, 1308, 1409, 1510, 1611, 1712],
    '虎': [1007, 1108, 1209, 1310, 1411, 1512, 1613, 1714],
    '兔': [1009, 1110, 1211, 1312, 1413, 1514, 1615, 1716],
    '龙': [1011, 1112, 1213, 1314, 1415, 1516, 1617, 1218],
    '蛇': [1013, 1114, 1215, 1316, 1417, 1518, 1619, 1720],
    '马': [1015, 1116, 1217, 1318, 1419, 1520, 1621, 1722],
    '羊': [1017, 1118, 1219, 1320, 1421, 1522, 1623, 1724],
    '猴': [1019, 1120, 1221, 1322, 1423, 1524, 1625, 1726],
    '鸡': [1021, 1122, 1223, 1324, 1425, 1526, 1627, 1728],
    '狗': [1023, 1124, 1225, 1326, 1427, 1528, 1629, 1730],
    '猪': [1025, 1126, 1227, 1328, 1429, 1530, 1631, 1732]
}

# 2. 四十八干支纳甲数图 (基础八宫纳甲) 
# 列表顺序：初爻 -> 上爻
# 格式：(天干, 地支)
BASE_NA_JIA = {
    '乾': [('甲', '子'), ('甲', '寅'), ('甲', '辰'), ('壬', '午'), ('壬', '申'), ('壬', '戌')],
    '兑': [('丁', '巳'), ('丁', '卯'), ('丁', '丑'), ('丁', '亥'), ('丁', '酉'), ('丁', '未')], # 注意：文档表格顺序可能有别，此处按标准纳甲补全
    '离': [('己', '卯'), ('己', '丑'), ('己', '亥'), ('己', '酉'), ('己', '未'), ('己', '巳')],
    '震': [('庚', '子'), ('庚', '寅'), ('庚', '辰'), ('庚', '午'), ('庚', '申'), ('庚', '戌')],
    '巽': [('辛', '丑'), ('辛', '亥'), ('辛', '酉'), ('辛', '未'), ('辛', '巳'), ('辛', '卯')],
    '坎': [('戊', '寅'), ('戊', '辰'), ('戊', '午'), ('戊', '申'), ('戊', '戌'), ('戊', '子')],
    '艮': [('丙', '辰'), ('丙', '午'), ('丙', '申'), ('丙', '戌'), ('丙', '子'), ('丙', '寅')],
    '坤': [('乙', '未'), ('乙', '巳'), ('乙', '卯'), ('癸', '丑'), ('癸', '亥'), ('癸', '酉')]
}

# 地支对应生肖
ZHI_ZODIAC = {
    '子': '鼠', '丑': '牛', '寅': '虎', '卯': '兔', '辰': '龙', '巳': '蛇',
    '午': '马', '未': '羊', '申': '猴', '酉': '鸡', '戌': '狗', '亥': '猪'
}

# ==========================================
# 算法逻辑：京房八宫六亲定位 (补全文档  缺失的逻辑)
# ==========================================

def get_gong_and_generation(upper, lower):
    """
    确定卦所在的宫位及世应位置（用于定六亲）
    标准京房易逻辑
    """
    # 简化版：仅处理本宫卦（纯卦）和简单归宫
    # 实际上需要完整的64卦归宫算法。
    # 这里为了演示，我们假设输入的都是八纯卦（如乾为天）。
    if upper == lower:
        return upper # 本宫卦，五行属该宫
    
    # 若需完整实现64卦归宫，需大量代码。
    # 考虑到Streamlit演示，我们此处模拟：
    # "若非八纯卦，暂按上卦所属宫位处理（仅做演示误差提示）"
    return upper 

def get_five_element(gan_or_zhi):
    """获取干支五行"""
    # 金: 庚辛申酉; 木: 甲乙寅卯; 水: 壬癸亥子; 火: 丙丁巳午; 土: 戊己辰戌丑未
    wuxing = {
        '甲': '木', '乙': '木', '寅': '木', '卯': '木',
        '丙': '火', '丁': '火', '巳': '火', '午': '火',
        '戊': '土', '己': '土', '辰': '土', '戌': '土', '丑': '土', '未': '土',
        '庚': '金', '辛': '金', '申': '金', '酉': '金',
        '壬': '水', '癸': '水', '亥': '水', '子': '水'
    }
    return wuxing.get(gan_or_zhi, '')

def get_relation(me_element, other_element):
    """
    六亲生克关系
    生我者父母，我生者子孙，克我者官鬼，我克者妻财，同我者兄弟
    """
    relations = {
        ('金', '金'): '兄弟', ('金', '水'): '子孙', ('金', '木'): '妻财', ('金', '火'): '官鬼', ('金', '土'): '父母',
        ('木', '木'): '兄弟', ('木', '火'): '子孙', ('木', '土'): '妻财', ('木', '金'): '官鬼', ('木', '水'): '父母',
        ('水', '水'): '兄弟', ('水', '木'): '子孙', ('水', '火'): '妻财', ('水', '土'): '官鬼', ('水', '金'): '父母',
        ('火', '火'): '兄弟', ('火', '土'): '子孙', ('火', '金'): '妻财', ('火', '水'): '官鬼', ('火', '木'): '父母',
        ('土', '土'): '兄弟', ('土', '金'): '子孙', ('土', '水'): '妻财', ('土', '木'): '官鬼', ('土', '火'): '父母',
    }
    return relations.get((me_element, other_element), '未知')

def liu_qin_judge(main_gua_name):
    """
    六亲生肖判断主函数 [cite: 1265-1270]
    """
    # 1. 确定卦宫五行 (我)
    # 假设 main_gua_name 是 "乾"，则五行属金
    gong = main_gua_name # 简化：只处理八纯卦
    if gong not in BASE_NA_JIA:
        return "非八纯卦，演示模式暂不支持复杂归宫"
        
    gong_element = get_five_element(gong if gong in ['庚','辛'] else '庚') # 乾属金
    # 修正五行映射：乾兑金，离火，震巽木，坎水，艮坤土
    GONG_ELEMENTS = {'乾': '金', '兑': '金', '离': '火', '震': '木', '巽': '木', '坎': '水', '艮': '土', '坤': '土'}
    me = GONG_ELEMENTS.get(gong)
    
    lines = BASE_NA_JIA[gong]
    results = []
    
    for idx, (gan, zhi) in enumerate(lines):
        line_element = get_five_element(zhi)
        relation = get_relation(me, line_element)
        zodiac = ZHI_ZODIAC[zhi]
        
        # 匹配条文数 
        codes = ZODIAC_CODES.get(zodiac, [])
        # 简单取第一个条文演示
        code_demo = codes[0] if codes else "无"
        
        # 逻辑： "父母之生肖...将干支之属性做为父母生肖"
        desc = f"第{idx+1}爻 ({gan}{zhi}): 五行{line_element} -> 为【{relation}】 -> 属{zodiac}"
        
        if relation == '父母':
            desc += f" (父/母生肖参考: {zodiac}, 条文数: {code_demo})"
        elif relation == '子孙':
            desc += f" (子/女生肖参考: {zodiac}, 条文数: {code_demo})"
            
        results.append(desc)
        
    return results

# ==========================================
# Streamlit 界面集成
# ==========================================
st.markdown("---")
st.header("8. 六亲判断秘法 [cite: 1263]")
st.info("基于文档第八章逻辑与附表数据 ")

# 演示选择
demo_gua = st.selectbox("选择演示卦象（仅限八纯卦）", list(BASE_NA_JIA.keys()))

if st.button("推算六亲生肖"):
    st.write(f"**{demo_gua}为{demo_gua}** (本宫卦)")
    res_lines = liu_qin_judge(demo_gua)
    
    for l in res_lines:
        st.text(l)
        
    st.caption("注：判断依据  '将干支之属性做为父母生肖'。条文数取自  '六亲生肖秘表'。")
